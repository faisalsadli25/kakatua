<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Erafone M185 - Smart Inventory</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
    .bg-navy { background-color: #0f172a; }
    @keyframes blink { 0%, 100% { opacity: 1; color: #ef4444; } 50% { opacity: 0.4; color: #fca5a5; } }
    .blink-alert { animation: blink 1s infinite; font-weight: 800; }
  </style>
</head>
<body class="text-slate-900 overflow-x-hidden">

<div id="loginModal" class="fixed inset-0 bg-red-400 z-[100] flex items-center justify-center p-4">
  <div class="bg-white rounded-[2.5rem] p-10 w-full max-w-md shadow-2xl text-center">
    <div class="flex justify-center mb-6">
        <div class="w-16 h-16 bg-red-500 rounded-2xl flex items-center justify-center shadow-xl transform -rotate-6 text-white text-2xl font-black italic">E</div>
    </div>
    <h2 class="text-2xl font-extrabold text-navy italic text-blue-700">ERAFONE <span class="text-red-500">N  MORE KAKATUA</span></h2>
    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.2em] mb-8">Stock Management System</p>
    <form id="loginForm" class="space-y-4">
      <input id="nama" type="text" placeholder="Username" class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-6 py-4 outline-none focus:ring-4 focus:ring-navy/5 focus:border-navy transition-all font-semibold" required>
      <input id="password" type="password" placeholder="Password" class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-6 py-4 outline-none focus:ring-4 focus:ring-navy/5 focus:border-navy transition-all font-semibold" required>
      <button class=" w-full bg-white text-red-500 py-4 border rounded-2xl font-bold hover:bg-red-600 active:scale-95 transition-all uppercase tracking-widest text-xs mt-4 hover:text-white">Masuk</button>
    </form>
  </div>
</div>

<header class="sticky top-0 z-50 bg-navy/95 backdrop-blur-md text-white shadow-xl">
  <div class="max-w-7xl mx-auto px-6 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
    <div class="flex items-center gap-4">
        <div class="w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center font-black italic border border-white/10 text-lg">E</div>
        <div>
            <h1 class="text-md font-black italic uppercase tracking-tighter">Maros M114</h1>
            <div class="flex items-center gap-2 mt-0.5 text-[10px]">
                <span id="status-badge" class="w-2 h-2 rounded-full bg-slate-500"></span>
                <span id="status-text" class="font-bold text-slate-400 uppercase tracking-widest">Menghubungkan...</span>
            </div>
        </div>
    </div>
    
    <div id="user-display" class="hidden flex items-center gap-4">
        <div class="text-right">
            <p id="user-name" class="text-xs font-black uppercase tracking-wider"></p>
            <p id="last-update" class="text-[9px] text-slate-400 font-bold tracking-tight"></p>
        </div>
        <button onclick="loadData()" class="bg-white/5 hover:bg-white/10 p-2.5 rounded-xl border border-white/5 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
        </button>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto p-6 md:p-8">
  <div class="mb-8 max-w-lg">
    <div class="relative group">
        <input id="search-bar" type="text" placeholder="Cari tipe unit..." 
               class="w-full bg-slate-400 border-2 border-slate-100 rounded-2xl px-6 py-4 shadow-sm focus:border-navy outline-none font-semibold transition-all text-white" oninput="filterItems()">
        <div class="absolute right-5 top-1/2 -translate-y-1/2 text-slate-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
        </div>
    </div>
  </div>

  <div class="hidden md:block overflow-hidden bg-white rounded-3xl shadow-xl border border-slate-100">
    <table class="min-w-full">
      <thead class="bg-slate-50/50 text-[10px] font-black text-slate-400 uppercase tracking-widest border-b border-slate-100">
        <tr>
          <th class="px-8 py-5 text-left">Material ID</th>
          <th class="px-8 py-5 text-left">Deskripsi Produk</th>
          <th class="px-8 py-5 text-center">In</th>
          <th class="px-8 py-5 text-center">Out</th>
          <th class="px-8 py-5 text-center">Stok</th>
        </tr>
      </thead>
      <tbody id="tabel-desktop" class="divide-y divide-slate-50"></tbody>
    </table>
  </div>

  <div id="tabel-mobile" class="md:hidden space-y-4"></div>
</main>

<script>
const PASSWORD_BENAR = "m185";
const NAMA_DIIJINKAN = ["kakatua"];
const SHEET_ID = "1y3BLZuMrOWzNxHY_e3v9feUuQSQahyCXuRwX4rdSNW0";
const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;

let isSearching = false; // Flag untuk mencegah refresh saat mengetik
let currentData = [];

document.getElementById("loginForm").addEventListener("submit", e => {
  e.preventDefault();
  const namaInput = document.getElementById("nama").value.trim();
  const passInput = document.getElementById("password").value;
  const user = NAMA_DIIJINKAN.find(u => u.toLowerCase() === namaInput.toLowerCase());

  if (passInput === PASSWORD_BENAR && user) {
    document.getElementById("loginModal").classList.add("hidden");
    document.getElementById("user-name").textContent = user;
    document.getElementById("user-display").classList.remove("hidden");
    loadData();
    setInterval(loadData, 30000); // Auto update 30 detik
  } else {
    alert("Username/Password salah!");
  }
});

async function loadData() {
  const statusBadge = document.getElementById("status-badge");
  const statusText = document.getElementById("status-text");
  
  try {
    const res = await fetch(url);
    const csvData = await res.text();
    // Parse CSV simple (menangani tanda kutip)
    const rows = csvData.split('\n').map(r => r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/));
    
    currentData = rows;
    document.getElementById("last-update").textContent = "Update: " + new Date().toLocaleTimeString('id-ID');
    statusBadge.className = "w-2 h-2 rounded-full bg-emerald-500";
    statusText.textContent = "Tersambung";

    // HANYA RENDER ULANG JIKA USER TIDAK SEDANG MENCARI
    if (!isSearching) {
        renderUI(rows);
    }
  } catch (err) {
    statusBadge.className = "w-2 h-2 rounded-full bg-red-500";
    statusText.textContent = "Koneksi Bermasalah";
  }
}

function renderUI(rows) {
  const desktop = document.getElementById("tabel-desktop");
  const mobile = document.getElementById("tabel-mobile");
  desktop.innerHTML = "";
  mobile.innerHTML = "";

  for (let i = 1; i < rows.length; i++) {
    const col = rows[i];
    if (!col[1]) continue;

    const id = (col[0] || "").replace(/"/g, "");
    const nama = (col[1] || "").replace(/"/g, "");
    const inQty = parseInt(col[2]) || 0;
    const outQty = parseInt(col[3]) || 0;
    const sisa = inQty - outQty;

    let styleClass = "bg-slate-100 text-navy";
    if (sisa === 1) styleClass = "bg-red-50 text-red-600 border-red-100 blink-alert";
    if (sisa <= 0) styleClass = "bg-slate-50 text-slate-300 border-transparent";

    desktop.innerHTML += `
      <tr class="hover:bg-slate-50 transition-colors">
        <td class="px-8 py-4 text-[10px] font-bold text-slate-400 font-mono tracking-wider">${id}</td>
        <td class="px-8 py-4 font-bold text-navy text-xs uppercase">${nama}</td>
        <td class="px-8 py-4 text-center font-bold text-slate-500">${inQty}</td>
        <td class="px-8 py-4 text-center font-bold text-slate-500">${outQty}</td>
        <td class="px-8 py-4 text-center"><span class="${styleClass} px-4 py-1.5 rounded-xl border font-black text-sm min-w-[3rem] inline-block">${sisa}</span></td>
      </tr>`;

    mobile.innerHTML += `
      <div class="bg-white rounded-3xl p-5 border border-slate-100 shadow-sm">
        <div class="flex justify-between items-center mb-3">
            <span class="text-[9px] font-bold text-slate-300 font-mono tracking-widest">${id}</span>
            <span class="text-[8px] font-black ${sisa > 0 ? 'text-emerald-500' : 'text-slate-300'} uppercase tracking-tighter">${sisa > 0 ? 'Ready' : 'Habis'}</span>
        </div>
        <h3 class="font-black text-navy text-xs uppercase mb-4 leading-tight">${nama}</h3>
        <div class="grid grid-cols-3 gap-2 bg-slate-50 rounded-2xl p-3 text-center">
            <div><p class="text-[8px] font-bold text-slate-400 uppercase">In</p><p class="text-xs font-bold text-navy">${inQty}</p></div>
            <div class="border-x border-slate-200"><p class="text-[8px] font-bold text-slate-400 uppercase">Out</p><p class="text-xs font-bold text-navy">${outQty}</p></div>
            <div><p class="text-[8px] font-bold text-slate-400 uppercase">Stok</p><p class="text-xs font-black ${sisa === 1 ? 'blink-alert' : (sisa <= 0 ? 'text-slate-300' : 'text-navy')}">${sisa}</p></div>
        </div>
      </div>`;
  }
}

function filterItems() {
  const q = document.getElementById("search-bar").value.toLowerCase();
  
  // Set flag isSearching agar loadData() tidak me-render ulang UI
  isSearching = q.length > 0;

  const dRows = document.getElementById("tabel-desktop").rows;
  const mCards = document.getElementById("tabel-mobile").children;

  for (let r of dRows) {
    r.style.display = r.innerText.toLowerCase().includes(q) ? "" : "none";
  }
  for (let c of mCards) {
    c.style.display = c.innerText.toLowerCase().includes(q) ? "" : "none";
  }
  
  // Jika kolom pencarian dikosongkan kembali, segera render dengan data terbaru
  if (!isSearching) {
    renderUI(currentData);
  }
}
</script>
</body>
</html>